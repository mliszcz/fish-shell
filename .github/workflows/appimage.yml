name: appimage

on: [push, pull_request, workflow_dispatch]

env:
  CTEST_PARALLEL_LEVEL: "1"
  CMAKE_BUILD_PARALLEL_LEVEL: "4"

jobs:
  appimage:

    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Create version file
      # A 'version' file is needed to overwrite the one generated by the
      # git_version_gen.sh script as the AppImage commit must be dropped.
      run: git describe --always HEAD~1 > version
    - name: Prepare AppImage
      run: |
        docker run --privileged --rm -v `pwd`:/work -e CTEST_PARALLEL_LEVEL -e CMAKE_BUILD_PARALLEL_LEVEL centos:7 sh -c /work/build_tools/make_appimage_centos7.sh
    - uses: actions/upload-artifact@v3
      with:
        name: appimage
        path: '*.AppImage'
        retention-days: 1

  release:
    if: ${{ false }}  # disable for now
    runs-on: ubuntu-latest
    needs: [appimage]
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 2 # NOTE: there is 1 commit to drop.
    - uses: actions/download-artifact@v3
    - run: echo "tag=$(basename appimage/*.AppImage .AppImage)" >> $GITHUB_ENV
    - run: echo "rev=$(git rev-parse HEAD~1)" >> $GITHUB_ENV
    - uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.tag }}
        target_commitish: ${{ env.rev }}
        body: fish-shell/fish-shell@${{ env.rev }}
        files: 'appimage/*.AppImage'
